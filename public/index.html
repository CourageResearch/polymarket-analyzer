<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Polymarket Analyzer - Largest Company 2025</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      min-height: 100vh;
      padding: 40px;
    }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { color: #f0f6fc; margin-bottom: 8px; }
    .subtitle { color: #8b949e; margin-bottom: 30px; }

    .market-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }
    .market-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .market-title { font-size: 20px; color: #f0f6fc; }
    .market-deadline { color: #f85149; font-size: 14px; font-weight: 500; }

    .outcomes-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 24px;
    }
    .outcomes-table th {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid #30363d;
      color: #8b949e;
      font-size: 12px;
      text-transform: uppercase;
    }
    .outcomes-table td {
      padding: 16px 12px;
      border-bottom: 1px solid #21262d;
    }
    .outcomes-table tr:hover { background: #21262d; }
    .company-name { color: #f0f6fc; font-weight: 500; font-size: 16px; }
    .market-odds { color: #58a6ff; font-size: 20px; font-weight: 600; }
    .ai-odds { font-size: 20px; font-weight: 600; }
    .volume { color: #8b949e; font-size: 14px; }

    .verdict {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
    }
    .verdict.buy { background: #238636; color: #fff; }
    .verdict.sell { background: #da3633; color: #fff; }
    .verdict.fair { background: #30363d; color: #8b949e; }
    .verdict.unknown { background: #21262d; color: #6e7681; }

    .discrepancy { font-size: 14px; font-weight: 500; }
    .discrepancy.positive { color: #3fb950; }
    .discrepancy.negative { color: #f85149; }
    .discrepancy.neutral { color: #8b949e; }

    .analyze-btn {
      background: linear-gradient(135deg, #238636, #2ea043);
      border: none;
      color: #fff;
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
    }
    .analyze-btn:hover { background: linear-gradient(135deg, #2ea043, #3fb950); }
    .analyze-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .analysis-summary {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 24px;
      margin-top: 24px;
    }
    .analysis-summary h3 { color: #f0f6fc; margin-bottom: 16px; }
    .analysis-text {
      white-space: pre-wrap;
      line-height: 1.7;
      color: #c9d1d9;
      font-size: 14px;
    }
    .analysis-text strong { color: #f0f6fc; }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 40px;
      color: #8b949e;
    }
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #30363d;
      border-top-color: #58a6ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .error { color: #f85149; padding: 16px; background: #3d1a1a; border-radius: 8px; }

    .legend {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
      font-size: 13px;
    }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .legend-dot { width: 12px; height: 12px; border-radius: 3px; }
    .legend-dot.buy { background: #238636; }
    .legend-dot.sell { background: #da3633; }
    .legend-dot.fair { background: #30363d; }

    .top-picks {
      background: linear-gradient(135deg, #1a2e1a, #161b22);
      border: 2px solid #238636;
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: none;
    }
    .top-picks h3 { color: #3fb950; font-size: 18px; margin-bottom: 12px; }
    .top-picks-list { display: flex; flex-wrap: wrap; gap: 12px; }
    .pick-chip {
      background: #238636;
      color: #fff;
      padding: 10px 18px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 15px;
    }
    .pick-chip.sell { background: #da3633; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Polymarket Analyzer</h1>
    <p class="subtitle">AI-powered analysis of prediction market odds</p>

    <div class="top-picks" id="topPicks">
      <h3>ðŸŽ¯ Mispriced Bets Found</h3>
      <div class="top-picks-list" id="topPicksList"></div>
    </div>

    <div class="market-card">
      <div class="market-header">
        <div class="market-title">Largest Company end of 2025?</div>
        <div class="market-deadline" id="deadline"></div>
      </div>

      <div class="legend">
        <div class="legend-item"><div class="legend-dot buy"></div> Underpriced (BUY)</div>
        <div class="legend-item"><div class="legend-dot sell"></div> Overpriced (SELL)</div>
        <div class="legend-item"><div class="legend-dot fair"></div> Fair</div>
      </div>

      <table class="outcomes-table">
        <thead>
          <tr>
            <th>Company</th>
            <th>Market Odds</th>
            <th>AI Fair Value</th>
            <th>Difference</th>
            <th>Volume</th>
            <th>Signal</th>
          </tr>
        </thead>
        <tbody id="outcomesBody">
          <tr><td colspan="6"><div class="loading"><div class="spinner"></div><span>Loading...</span></div></td></tr>
        </tbody>
      </table>

      <button class="analyze-btn" id="analyzeBtn" disabled>Analyze with Claude AI</button>
    </div>

    <div class="analysis-summary" id="analysisPanel" style="display: none;">
      <h3>Full AI Analysis</h3>
      <div class="analysis-text" id="analysisText"></div>
    </div>
  </div>

  <script>
    let eventData = null;
    let marketData = {};

    async function loadMarket() {
      try {
        const res = await fetch('/api/event/largest-company-end-of-2025');
        eventData = await res.json();

        const endDate = new Date(eventData.endDate);
        const now = new Date();
        const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
        document.getElementById('deadline').textContent = `Resolves in ${daysLeft} days (Dec 31)`;

        renderOutcomes();
        document.getElementById('analyzeBtn').disabled = false;
      } catch (err) {
        document.getElementById('outcomesBody').innerHTML = `<tr><td colspan="6"><div class="error">Failed to load: ${err.message}</div></td></tr>`;
      }
    }

    function parseArray(val) {
      if (Array.isArray(val)) return val;
      try { return JSON.parse(val); } catch { return []; }
    }

    function renderOutcomes() {
      const activeMarkets = eventData.markets.filter(m => m.active && parseFloat(m.volume) > 0);
      activeMarkets.sort((a, b) => {
        const pa = parseArray(a.outcomePrices), pb = parseArray(b.outcomePrices);
        return parseFloat(pb[0]) - parseFloat(pa[0]);
      });

      const html = activeMarkets.map(m => {
        const prices = parseArray(m.outcomePrices);
        const yesPrice = (parseFloat(prices[0]) * 100).toFixed(1);
        const vol = (parseFloat(m.volume) / 1000000).toFixed(2);
        const company = m.groupItemTitle;
        marketData[company] = parseFloat(yesPrice);

        return `
          <tr data-company="${company}">
            <td><span class="company-name">${company}</span></td>
            <td><span class="market-odds">${yesPrice}%</span></td>
            <td><span class="ai-odds" id="ai-${company}">--</span></td>
            <td><span class="discrepancy neutral" id="diff-${company}">--</span></td>
            <td><span class="volume">$${vol}M</span></td>
            <td><span class="verdict unknown" id="verdict-${company}">Pending</span></td>
          </tr>
        `;
      }).join('');

      document.getElementById('outcomesBody').innerHTML = html;
    }

    async function analyze() {
      const btn = document.getElementById('analyzeBtn');
      const panel = document.getElementById('analysisPanel');
      const text = document.getElementById('analysisText');

      btn.disabled = true;
      btn.textContent = 'Analyzing...';
      panel.style.display = 'block';
      text.innerHTML = `<div class="loading"><div class="spinner"></div><span>Claude is checking current market caps...</span></div>`;

      try {
        const res = await fetch('/api/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ event: eventData })
        });

        const data = await res.json();
        if (data.error) throw new Error(data.error);

        updateTableWithAnalysis(data.analysis);
        text.innerHTML = data.analysis.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
      } catch (err) {
        text.innerHTML = `<div class="error">Error: ${err.message}</div>`;
      }

      btn.disabled = false;
      btn.textContent = 'Re-analyze';
    }

    function updateTableWithAnalysis(analysisText) {
      const companies = Object.keys(marketData);
      const topPicks = [];

      companies.forEach(company => {
        const marketOdds = marketData[company];

        // Extract AI probability estimates
        const patterns = [
          new RegExp(`${company}[:\\s]+(?:~)?(\\d+(?:\\.\\d+)?)%`, 'i'),
          new RegExp(`${company}[^\\d]+(\\d+(?:\\.\\d+)?)%`, 'i'),
        ];

        let aiOdds = null;
        for (const p of patterns) {
          const m = analysisText.match(p);
          if (m) { aiOdds = parseFloat(m[1]); break; }
        }

        const aiEl = document.getElementById(`ai-${company}`);
        const diffEl = document.getElementById(`diff-${company}`);
        const verdictEl = document.getElementById(`verdict-${company}`);

        if (aiOdds !== null && !isNaN(aiOdds)) {
          aiEl.textContent = `${aiOdds.toFixed(1)}%`;
          const diff = aiOdds - marketOdds;

          diffEl.textContent = `${diff >= 0 ? '+' : ''}${diff.toFixed(1)}%`;

          if (diff > 10) {
            diffEl.className = 'discrepancy positive';
            verdictEl.textContent = 'ðŸŸ¢ BUY';
            verdictEl.className = 'verdict buy';
            topPicks.push({ company, action: 'BUY', diff, isBuy: true });
          } else if (diff < -10) {
            diffEl.className = 'discrepancy negative';
            verdictEl.textContent = 'ðŸ”´ SELL';
            verdictEl.className = 'verdict sell';
            topPicks.push({ company, action: 'SELL', diff, isBuy: false });
          } else {
            diffEl.className = 'discrepancy neutral';
            verdictEl.textContent = 'FAIR';
            verdictEl.className = 'verdict fair';
          }
        } else {
          aiEl.textContent = '?';
        }
      });

      if (topPicks.length > 0) {
        document.getElementById('topPicks').style.display = 'block';
        document.getElementById('topPicksList').innerHTML = topPicks
          .sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff))
          .map(p => `<div class="pick-chip ${p.isBuy ? '' : 'sell'}">${p.action} ${p.company} (${p.diff > 0 ? '+' : ''}${p.diff.toFixed(0)}%)</div>`)
          .join('');
      }
    }

    document.getElementById('analyzeBtn').addEventListener('click', analyze);
    loadMarket();
  </script>
</body>
</html>
